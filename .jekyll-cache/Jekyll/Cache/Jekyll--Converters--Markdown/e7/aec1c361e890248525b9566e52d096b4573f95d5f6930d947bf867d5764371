I"ğq<!--more-->
<p>å¯¹ã€ŠC++ Concurrency In Actionã€‹ç¬¬4.4.2éƒ¨åˆ†çš„ä¸€ä¸ªè®°å½•ï¼Œä¸»è¦ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥å®ç°çº¿ç¨‹é—´çš„äº¤äº’ã€‚è¿™ç§åšæ³•å«åšCommunicating Sequential Processesï¼Œç®€ç§°CSPï¼Œå…¶æ€è·¯å°±æ˜¯å¦‚æœçº¿ç¨‹é—´æ²¡æœ‰å…±äº«çš„æ•°æ®é‚£ä¹ˆåˆ†æèµ·æ¥å°±ä¼šç®€å•å¾ˆå¤šï¼Œæˆ‘ä»¬åªéœ€è¦è€ƒè™‘æ¯ä¸ªçº¿ç¨‹åœ¨æ”¶åˆ°ç‰¹å®šçš„æ¶ˆæ¯æ—¶çš„è¡Œä¸ºå³å¯ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥è§†ä½œä¸€ä¸ªæœ‰é™çŠ¶æ€æœº</p>

<h3 id="atmæœºçš„å®ç°æ€è·¯">ATMæœºçš„å®ç°æ€è·¯</h3>
<p>ç°åœ¨æ€è€ƒä¸€ä¸‹ATMæœºçš„å·¥ä½œæµç¨‹ï¼Œåˆå§‹çŠ¶æ€ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå½“æ’å…¥é“¶è¡Œå¡åä¼šè¿›å…¥è¾“å…¥å¯†ç çš„ç¯èŠ‚ï¼Œæ­¤æ—¶å¯ä»¥è¾“å…¥å¯†ç ã€å›é€€æˆ–æ˜¯å–æ¶ˆã€‚å½“è¾“å…¥6ä¸ªæ•°å­—åè¿›è¡Œå¯†ç æ ¡éªŒï¼Œå¦‚æœæˆåŠŸåˆ™è¿›å…¥è´¦æˆ·é¡µé¢ã€‚è´¦æˆ·é¡µé¢å¯ä»¥å–æ¬¾ã€æŸ¥è¯¢ä½™é¢ï¼Œå–æ¬¾æ—¶éœ€è¦è¾“å…¥é‡‘é¢å¹¶å‘é“¶è¡Œç¡®è®¤äº¤æ˜“ç»“æœï¼ŒæˆåŠŸåˆ™æœºå™¨å–å‡ºå¯¹åº”çš„é’ç¥¨ï¼Œå¦åˆ™æç¤ºå¤±è´¥ã€‚æ€»ä½“ä¸Šæ¥çœ‹æˆ‘ä»¬å¯ä»¥åˆ†æˆä¸‰ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼š</p>
<ol>
  <li>é€»è¾‘çº¿ç¨‹ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥ã€çŠ¶æ€æµè½¬</li>
  <li>ç¡¬ä»¶çº¿ç¨‹ï¼šå±•ç¤ºå¯¹åº”ä¿¡æ¯ã€æå–ç°é‡‘</li>
  <li>é“¶è¡Œçº¿ç¨‹ï¼šæ ¡éªŒå¯†ç å’Œä½™é¢æƒ…å†µ</li>
</ol>

<h3 id="æµç¨‹å›¾">æµç¨‹å›¾</h3>
<p><img src="/assets/images/ATM.png" alt="Image" /></p>

<h3 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h3>
<p>é¦–å…ˆå®ç°ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¨¡å‹ï¼Œæ”¯æŒä»»æ„ç±»å‹çš„æ¶ˆæ¯</p>
<h4 id="messageç±»">Messageç±»</h4>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sr">//</span> <span class="err">åŸºç±»</span>
<span class="n">struct</span> <span class="no">MessageBase</span> <span class="p">{</span>
<span class="ss">public:
  </span><span class="n">virtual</span> <span class="o">~</span><span class="no">MessageBase</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="sr">//</span> <span class="err">åŒ…è£…ç±»ï¼Œæ¨¡æ¿å‚æ•°æŒ‡å®šæ¶ˆæ¯ç±»å‹</span>
<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="no">Message</span><span class="o">&gt;</span>
<span class="n">struct</span> <span class="no">WrapperMessage</span> <span class="p">:</span> <span class="kp">public</span> <span class="no">MessageBase</span> <span class="p">{</span>
<span class="ss">public:
  </span><span class="n">explicit</span> <span class="no">WrapperMessage</span><span class="p">(</span><span class="n">const</span> <span class="no">Message</span><span class="o">&amp;</span> <span class="n">content</span><span class="p">)</span> <span class="p">:</span> <span class="n">content_</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="p">{}</span>
  <span class="no">Message</span> <span class="n">content_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<h4 id="messagequeueç±»">MessageQueueç±»</h4>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sr">//</span> <span class="err">ä½¿ç”¨äº’æ–¥é”å’Œæ¡ä»¶å˜é‡ç®¡ç†çš„æ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="k">class</span> <span class="nc">MessageQueue</span> <span class="p">{</span>
<span class="ss">public:
  </span><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="no">Message</span><span class="o">&gt;</span>
  <span class="n">void</span> <span class="no">Push</span><span class="p">(</span><span class="n">const</span> <span class="no">Message</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lg</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
    <span class="n">queue_</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="no">WrapperMessage</span><span class="o">&lt;</span><span class="no">Message</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
    <span class="n">cv_</span><span class="p">.</span><span class="nf">notify_all</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="no">MessageBase</span><span class="o">&gt;</span> <span class="no">WaitAndPop</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">l</span><span class="p">(</span><span class="n">m_</span><span class="p">);</span>
    <span class="n">cv_</span><span class="p">.</span><span class="nf">wait</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]{</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">queue_</span><span class="p">.</span><span class="nf">empty</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="n">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">queue_</span><span class="p">.</span><span class="nf">front</span><span class="p">();</span>
    <span class="n">queue_</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
  <span class="p">}</span>

<span class="ss">private:
  </span><span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="no">MessageBase</span><span class="o">&gt;&gt;</span> <span class="n">queue_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">cv_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<h4 id="senderå’Œreceiverç±»">Senderå’ŒReceiverç±»</h4>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sr">//</span> <span class="no">Sender</span><span class="err">ç±»å¼•ç”¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶å‘å…¶æ¨é€è‡ªå®šä¹‰æ¶ˆæ¯</span>
<span class="k">class</span> <span class="nc">Sender</span> <span class="p">{</span>
<span class="ss">public:
  </span><span class="n">explicit</span> <span class="no">Sender</span><span class="p">(</span><span class="no">MessageQueue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span> <span class="p">:</span> <span class="n">queue_</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="no">Message</span><span class="o">&gt;</span>
  <span class="n">void</span> <span class="no">Send</span><span class="p">(</span><span class="n">const</span> <span class="no">Message</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">queue_</span><span class="o">-&gt;</span><span class="no">Push</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="p">}</span>

<span class="ss">private:
  </span><span class="no">MessageQueue</span><span class="o">*</span> <span class="n">queue_</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="sr">//</span> <span class="no">Receiver</span><span class="err">ç±»æŒæœ‰ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ›å»º</span><span class="no">Dispatcher</span><span class="err">ç±»æ¥å¤„ç†å…¶ä¸­çš„æ¶ˆæ¯ã€‚æ”¯æŒè½¬åŒ–ä¸º</span><span class="no">Sender</span><span class="err">æ¥åˆ©ç”¨å…¶ä¸­çš„é˜Ÿåˆ—å‘é€æ¶ˆæ¯</span>
<span class="k">class</span> <span class="nc">Receiver</span> <span class="p">{</span>
<span class="ss">public:
  </span><span class="no">Dispatcher</span> <span class="no">Wait</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">Dispatcher</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue_</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">operator</span> <span class="no">Sender</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">Sender</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue_</span><span class="p">);</span>
  <span class="p">}</span>

<span class="ss">private:
  </span><span class="no">MessageQueue</span> <span class="n">queue_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="dispatcherç±»">Dispatcherç±»</h4>
<p><code class="language-plaintext highlighter-rouge">Dispatcher</code>ç±»æ˜¯ä¸€ä¸ªä¸“é—¨è´Ÿè´£åˆ†å‘æ¶ˆæ¯çš„ç±»ï¼Œå½“å®ƒææ„æ—¶å®ƒä¼šå°è¯•å°†å¯¹åº”é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„æ¶ˆæ¯åˆ†å‘å‡ºå»ã€‚è¿™å…¶å®åªæ˜¯ä¸€ä¸ªå…œåº•æ“ä½œï¼Œå¤§å¤šæ•°æƒ…å†µæ˜¯é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">Handle</code>å‡½æ•°æ¥å¤„ç†ç‰¹å®šçš„æ¶ˆæ¯ã€‚æ³¨æ„è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">chained_</code>æˆå‘˜å˜é‡ç”¨æ¥æ ‡è®°è¿™ä¸ªDispatcheræ˜¯ä¸æ˜¯å·²ç»â€œé“¾â€è¿›å»äº†ï¼Œä¸»è¦æ˜¯é¿å…é‡å¤è¿›è¡Œåˆ†å‘ã€‚åœ¨å®ç°ä¸­æˆ‘ä»¬å°†<code class="language-plaintext highlighter-rouge">Dispatcher</code>ä¸€ä¸ªä¸ªé“¾èµ·æ¥å¤„ç†æ¶ˆæ¯çš„æ—¶å€™ä¼šçœ‹çš„æ›´æ¸…æ¥š
<code class="language-plaintext highlighter-rouge">TemplateDispatcher</code>å’Œ<code class="language-plaintext highlighter-rouge">Dispatcher</code>ç±»å‡ ä¹ä¸€æ ·ï¼Œä½†æ˜¯å¢åŠ äº†å¤„ç†çš„Messageå’ŒFuncä½œä¸ºæ¨¡æ¿å‚æ•°</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">struct</span> <span class="no">CloseQueue</span> <span class="p">{};</span>

<span class="k">class</span> <span class="nc">Dispatcher</span> <span class="p">{</span>
<span class="ss">public:
  </span><span class="n">explicit</span> <span class="no">Dispatcher</span><span class="p">(</span><span class="no">MessageQueue</span><span class="o">*</span> <span class="n">queue</span><span class="p">)</span> <span class="p">:</span> <span class="n">queue_</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="p">{}</span>
  <span class="no">Dispatcher</span><span class="p">(</span><span class="no">Dispatcher</span><span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="p">:</span> <span class="n">queue_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="nf">queue_</span><span class="p">),</span> <span class="n">chained_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="nf">chained_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">other</span><span class="p">.</span><span class="nf">chained_</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="no">Dispatcher</span><span class="p">()</span> <span class="n">noexcept</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">chained_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="no">WaitAndDispatch</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="no">Dispatcher</span><span class="p">(</span><span class="n">const</span> <span class="no">Dispatcher</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="o">=</span> <span class="n">delete</span><span class="p">;</span>
  <span class="no">Dispatcher</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="n">const</span> <span class="no">Dispatcher</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="o">=</span> <span class="n">delete</span><span class="p">;</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="no">Dispatcher</span><span class="p">,</span> <span class="n">typename</span> <span class="no">Msg</span><span class="p">,</span> <span class="n">typename</span> <span class="no">Func</span><span class="o">&gt;</span>
  <span class="n">friend</span> <span class="k">class</span> <span class="nc">TemplateDispatcher</span><span class="p">;</span>

  <span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="no">Message</span><span class="p">,</span> <span class="n">typename</span> <span class="no">Func</span><span class="o">&gt;</span>
  <span class="no">TemplateDispatcher</span><span class="o">&lt;</span><span class="no">Dispatcher</span><span class="p">,</span> <span class="no">Message</span><span class="p">,</span> <span class="no">Func</span><span class="o">&gt;</span> <span class="no">Handle</span><span class="p">(</span><span class="no">Func</span><span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">TemplateDispatcher</span><span class="p">(</span><span class="n">queue_</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="no">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">bool</span> <span class="no">Dispatch</span><span class="p">(</span><span class="n">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="no">MessageBase</span><span class="o">&gt;&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dynamic_cast</span><span class="o">&lt;</span><span class="no">WrapperMessage</span><span class="o">&lt;</span><span class="no">CloseQueue</span><span class="o">&gt;*&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">get</span><span class="p">()))</span> <span class="p">{</span>
        <span class="kp">throw</span> <span class="no">CloseQueue</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kp">false</span><span class="p">;</span>
  <span class="p">}</span>

<span class="ss">private:
  </span><span class="n">void</span> <span class="no">WaitAndDispatch</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">auto</span> <span class="n">message</span> <span class="o">=</span> <span class="n">queue_</span><span class="o">-&gt;</span><span class="no">WaitAndPop</span><span class="p">();</span>
        <span class="no">Dispatch</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="ss">private:
  </span><span class="no">MessageQueue</span><span class="o">*</span> <span class="n">queue_</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">chained_</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="no">PreviousDispatcher</span><span class="p">,</span> <span class="n">typename</span> <span class="no">Message</span><span class="p">,</span> <span class="n">typename</span> <span class="no">Func</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">TemplateDispatcher</span> <span class="p">{</span>
<span class="ss">public:
  </span><span class="no">TemplateDispatcher</span><span class="p">(</span><span class="no">MessageQueue</span><span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="no">PreviousDispatcher</span><span class="o">*</span> <span class="n">previous</span><span class="p">,</span> <span class="no">Func</span><span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">)</span> <span class="p">:</span>
  <span class="n">queue_</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="n">chained_</span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">chained_</span><span class="p">),</span> <span class="n">previous_</span><span class="p">(</span><span class="n">previous</span><span class="p">),</span> <span class="n">f_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="no">Func</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">previous</span><span class="o">-&gt;</span><span class="n">chained_</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="no">TemplateDispatcher</span><span class="p">(</span><span class="no">TemplateDispatcher</span><span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="p">:</span>
  <span class="n">queue_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="nf">queue_</span><span class="p">),</span> <span class="n">chained_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="nf">chained_</span><span class="p">),</span> <span class="n">previous_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="nf">previous_</span><span class="p">),</span> <span class="n">f_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="nf">f_</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">other</span><span class="p">.</span><span class="nf">chained_</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="no">TemplateDispatcher</span><span class="p">(</span><span class="n">const</span> <span class="no">TemplateDispatcher</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="o">=</span> <span class="n">delete</span><span class="p">;</span>
  <span class="no">TemplateDispatcher</span> <span class="o">&amp;</span><span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="n">const</span> <span class="no">TemplateDispatcher</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="o">=</span> <span class="n">delete</span><span class="p">;</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="no">Dispatcher</span><span class="p">,</span> <span class="n">typename</span> <span class="no">OtherMsg</span><span class="p">,</span> <span class="n">typename</span> <span class="no">OtherFunc</span><span class="o">&gt;</span>
  <span class="n">friend</span> <span class="k">class</span> <span class="nc">TemplateDispatcher</span><span class="p">;</span>
  
  <span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="no">OtherMessage</span><span class="p">,</span> <span class="n">typename</span> <span class="no">OtherFunc</span><span class="o">&gt;</span>
  <span class="no">TemplateDispatcher</span><span class="o">&lt;</span><span class="no">TemplateDispatcher</span><span class="p">,</span> <span class="no">OtherMessage</span><span class="p">,</span> <span class="no">OtherFunc</span><span class="o">&gt;</span> <span class="no">Handle</span><span class="p">(</span><span class="no">OtherFunc</span><span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">TemplateDispatcher</span><span class="p">(</span><span class="n">queue_</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="no">OtherFunc</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="no">TemplateDispatcher</span><span class="p">()</span> <span class="n">noexcept</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">chained_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="no">WaitAndDispatch</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">bool</span> <span class="no">Dispatch</span><span class="p">(</span><span class="n">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="no">MessageBase</span><span class="o">&gt;&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">auto</span><span class="o">*</span> <span class="n">wrapper_message</span> <span class="o">=</span> <span class="n">dynamic_cast</span><span class="o">&lt;</span><span class="no">WrapperMessage</span><span class="o">&lt;</span><span class="no">Message</span><span class="o">&gt;*&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">get</span><span class="p">()))</span> <span class="p">{</span>
        <span class="n">f_</span><span class="p">(</span><span class="n">wrapper_message</span><span class="o">-&gt;</span><span class="n">content_</span><span class="p">);</span>
        <span class="k">return</span> <span class="kp">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">previous_</span><span class="o">-&gt;</span><span class="no">Dispatch</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kp">false</span><span class="p">;</span>
  <span class="p">}</span>

<span class="ss">private:
  </span><span class="n">void</span> <span class="no">WaitAndDispatch</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">auto</span> <span class="n">message</span> <span class="o">=</span> <span class="n">queue_</span><span class="o">-&gt;</span><span class="no">WaitAndPop</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="no">Dispatch</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="ss">private:
  </span><span class="no">MessageQueue</span><span class="o">*</span> <span class="n">queue_</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">chained_</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
  <span class="no">PreviousDispatcher</span><span class="o">*</span> <span class="n">previous_</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="no">Func</span> <span class="n">f_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Dispatcherä½¿ç”¨å®ä¾‹ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Receiver receiver;
receiver.Wait().Handle&lt;Message1&gt;([](const Message1&amp;){
  // Do something...
}).Handle&lt;Message2&gt;([](const Message2&amp;){
  // Do something...
});
</code></pre></div></div>
<p>è¿‡ç¨‹åˆ†æï¼š</p>
<ul>
  <li>è°ƒç”¨è¿™è¡Œä»£ç æ—¶ä¼šåˆ›å»ºè‹¥å¹²ä¸ª<code class="language-plaintext highlighter-rouge">Dispatcher</code>å’Œ<code class="language-plaintext highlighter-rouge">TemplateDispatcher</code>å¯¹è±¡ï¼Œå®ƒä»¬å¼•ç”¨åŒä¸€ä¸ª<code class="language-plaintext highlighter-rouge">MessageQueue</code></li>
  <li>æ‰§è¡Œå®Œè¿™æ¡è¯­å¥åï¼Œä»åå‘å‰ä¾æ¬¡è°ƒç”¨æ¯ä¸ªå¯¹è±¡çš„ææ„å‡½æ•°ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯åˆ™é˜»å¡åœ¨<code class="language-plaintext highlighter-rouge">WaitAndDispatch</code>æ–¹æ³•ï¼Œå¦åˆ™å–å‡ºæ¶ˆæ¯åè¯•å›¾è¿›è¡Œåˆ†å‘ï¼Œå¦‚æœå½“å‰çš„<code class="language-plaintext highlighter-rouge">Dispatcher</code>å¤„ç†ä¸äº†ï¼ˆæ¶ˆæ¯ç±»å‹ä¸åŒ¹é…ï¼‰å°±ç»§ç»­ä¼ é€’ç»™å‰ä¸€ä¸ªè¿›è¡Œå¤„ç†</li>
  <li>å¦‚æœæŸæ¡æ¶ˆæ¯ç»è¿‡äº†å¤„ç†ï¼Œå°±ä»ææ„å‡½æ•°çš„æ— é™å¾ªç¯ä¸­é€€å‡ºã€‚ç”±äº<code class="language-plaintext highlighter-rouge">chained_</code>å˜é‡çš„å­˜åœ¨ï¼Œè¿™æ¡æ¶ˆæ¯æœ€å¤šåªä¼šè¢«å¤„ç†ä¸€æ¬¡</li>
</ul>

<h4 id="å…¥å£ä»£ç ">å…¥å£ä»£ç </h4>
<p>åœ¨å…·ä½“å®ç°çŠ¶æ€æœºå‰ï¼Œå¯ä»¥å…ˆå¤§è‡´å†™å‡ºå…¥å£ä»£ç </p>
<ol>
  <li>æˆ‘ä»¬éœ€è¦ä¸‰ä¸ªå¯¹è±¡æ¥åˆ†åˆ«å¤„ç†ä¸»çŠ¶æ€æœºã€ç¡¬ä»¶ä»¥åŠé“¶è¡Œçš„é€»è¾‘</li>
  <li>è¿™ä¸‰ä¸ªå¯¹è±¡åˆ†åˆ«åœ¨ä¸‰ä¸ªçº¿ç¨‹ä¸Šè¿›è¡Œå„è‡ªçš„å·¥ä½œ</li>
  <li>å®ƒä»¬é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥äº’ç›¸å‘é€æ¶ˆæ¯ã€‚ä¾‹å¦‚åˆå§‹çŠ¶æ€çŠ¶æ€æœºçº¿ç¨‹ç­‰å¾…æ’å…¥é“¶è¡Œå¡ï¼Œå½“æ’å…¥é“¶è¡Œå¡åç”±ç¡¬ä»¶çº¿ç¨‹è¾“å‡ºä¸€è¡Œæ¬¢è¿è¯­å¥ï¼Œæ¥ä¸‹æ¥ä¸»çº¿ç¨‹æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å‘é€ç»™çŠ¶æ€æœºçº¿ç¨‹å¤„ç†ç›¸å…³é€»è¾‘ï¼Œè¾“å…¥å®Œæ¯•ååˆ™å‘é€ç»™é“¶è¡Œçº¿ç¨‹è¿›è¡Œæ ¡éªŒâ€¦â€¦</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
BankMachine bank_machine(name, pin, balance);
HardwareMachine hardware_machine;
ATMMachine atm_machine(bank_machine.GetSender(),
                        hardware_machine.GetSender());
messaging::Sender sender(atm_machine.GetSender());
std::thread atm_thread(&amp;ATMMachine::Run, &amp;atm_machine);
std::thread bank_thread(&amp;BankMachine::Run, &amp;bank_machine);
std::thread hardware_thread(&amp;HardwareMachine::Run, &amp;hardware_machine);
...

atm_machine.Done();
hardware_machine.Done();
bank_machine.Done();
atm_thread.join();
hardware_thread.join();
bank_thread.join();
</code></pre></div></div>

<p>å‰©ä¸‹çš„è¿‡ç¨‹å…¶å®å°±æ˜¯æ…¢æ…¢æ ¹æ®çŠ¶æ€æµè½¬å›¾å»å®Œå–„è¿™ä¸‰ä¸ªç±»äº†ï¼Œå…·ä½“ä»£ç è¿™é‡Œå°±ä¸è¯¦ç»†åˆ—å‡ºäº†ï¼Œå¯ä»¥ç›´æ¥åœ¨<a href="https://github.com/mikucy/ATMDemo">Githubä»“åº“</a>æŸ¥çœ‹</p>
:ET